config:
  target: 'http://localhost:3000'
  phases:
    - duration: 30
      arrivalRate: 8
      name: 'Warm-up'
    - duration: 60
      arrivalRate: 8
      rampTo: 75
      name: 'Ramp-up'
    - duration: 120
      arrivalRate: 75
      name: 'Sustained load'
    - duration: 30
      arrivalRate: 75
      rampTo: 15
      name: 'Cool-down'
  variables:
    apiPrefix: '/api'
    testUserEmail: 'loadtest1@example.com'
    testUserPassword: 'LoadTest123!'
    productIds: ['uuid1', 'uuid2', 'uuid3']
  defaults:
    headers:
      Content-Type: 'application/json'
  ensure:
    maxErrorRate: 0.5
    p95: 400
    p99: 800

scenarios:
  - name: 'Shopping Cart Operations'
    flow:
      # Login first
      - post:
          url: '{{ apiPrefix }}/auth/login'
          json:
            email: '{{ testUserEmail }}'
            password: '{{ testUserPassword }}'
          expect:
            - statusCode: 200
          capture:
            json: '$.accessToken'
            as: 'accessToken'
      - think: 1
      # Get current cart
      - get:
          url: '{{ apiPrefix }}/cart'
          headers:
            Authorization: 'Bearer {{ accessToken }}'
          expect:
            - statusCode: 200
      - think: 1
      # Add first product
      - post:
          url: '{{ apiPrefix }}/cart/items'
          headers:
            Authorization: 'Bearer {{ accessToken }}'
          json:
            productId: '550e8400-e29b-41d4-a716-446655440000'
            quantity: 1
          expect:
            - statusCode: 201
          capture:
            json: '$.items[0].id'
            as: 'cartItemId1'
      - think: 2
      # Add second product
      - post:
          url: '{{ apiPrefix }}/cart/items'
          headers:
            Authorization: 'Bearer {{ accessToken }}'
          json:
            productId: '550e8400-e29b-41d4-a716-446655440001'
            quantity: 2
          expect:
            - statusCode: 201
      - think: 2
      # View cart
      - get:
          url: '{{ apiPrefix }}/cart'
          headers:
            Authorization: 'Bearer {{ accessToken }}'
          expect:
            - statusCode: 200
      - think: 1
      # Update quantity
      - patch:
          url: '{{ apiPrefix }}/cart/items/550e8400-e29b-41d4-a716-446655440000'
          headers:
            Authorization: 'Bearer {{ accessToken }}'
          json:
            quantity: 3
          expect:
            - statusCode: [200, 404]
      - think: 1
